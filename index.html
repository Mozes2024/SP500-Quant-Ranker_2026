<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>S&P 500 Mozes Ranker</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#070c12; --surface:#0c1520; --surface2:#111d2b; --surface3:#162436;
  --border:#1d2e40; --border2:#243a50;
  --gold:#f5a623; --gold2:#ffbf3b;
  --cyan:#39c3ff; --green:#34d399; --red:#fb7185; --purple:#a78bfa;
  --text:#e5e7eb; --muted:#9aa4b2; --muted2:#7b8794;
  --shadow: 0 20px 60px rgba(0,0,0,.45);
  --radius:18px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  background: radial-gradient(1200px 700px at 20% 10%, rgba(245,166,35,.12), transparent 55%),
              radial-gradient(900px 600px at 80% 20%, rgba(57,195,255,.10), transparent 55%),
              radial-gradient(900px 700px at 50% 90%, rgba(167,139,250,.08), transparent 55%),
              var(--bg);
  color:var(--text);
}
.wrap{max-width:1320px;margin:0 auto;padding:28px 18px 40px;}
.header{display:flex;align-items:flex-start;justify-content:space-between;gap:18px;margin-bottom:14px;}
.brand h1{margin:0;font-size:28px;letter-spacing:-0.02em;font-weight:900;}
.brand .sub{margin-top:6px;color:var(--muted);font-size:13px;display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.badge{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.04);border:1px solid var(--border);color:var(--muted);font-size:12px;}
.dot{width:8px;height:8px;border-radius:50%;background:var(--gold);box-shadow:0 0 0 3px rgba(245,166,35,.14);}
.live-dot{width:8px;height:8px;border-radius:50%;background:var(--green);box-shadow:0 0 0 3px rgba(52,211,153,.14);display:inline-block;margin-inline-end:8px;}
.header-right{display:flex;align-items:center;gap:10px;}
.lang-toggle{display:flex;background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:12px;overflow:hidden;}
.lang-toggle button{appearance:none;background:transparent;border:0;padding:8px 10px;color:var(--muted);font-weight:800;cursor:pointer;font-size:12px;}
.lang-toggle button.active{background:rgba(245,166,35,.15);color:var(--gold2);}
.card{background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));border:1px solid var(--border);border-radius: var(--radius);box-shadow: var(--shadow);}
.stats{display:grid;grid-template-columns: repeat(4, 1fr);gap:12px;padding:14px;margin: 14px 0;}
.stat{padding:14px 14px 12px;border-radius:14px;background:rgba(0,0,0,.18);border:1px solid rgba(255,255,255,.06);min-height:84px;}
.stat .label{color:var(--muted);font-size:12px;letter-spacing:.02em;margin-bottom:10px;}
.stat .value{font-size:22px;font-weight:900;letter-spacing:-0.02em;}
.stat .hint{margin-top:6px;color:var(--muted2);font-size:12px;font-family:"JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;}
.controls{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:14px;flex-wrap:wrap;}
.search{flex:1;min-width:260px;display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:14px;border:1px solid var(--border2);background:rgba(0,0,0,.20);}
.search input{width:100%;background:transparent;border:0;outline:0;color:var(--text);font-size:14px;}
.pills{display:flex;gap:8px;flex-wrap:wrap;align-items:center;}
.pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;background:rgba(255,255,255,.03);border:1px solid var(--border2);color:var(--muted);font-size:12px;cursor:pointer;user-select:none;}
.pill.active{background:rgba(57,195,255,.12);border-color: rgba(57,195,255,.35);color:#cfefff;}
.pill .mini{width:7px;height:7px;border-radius:50%;background:var(--cyan);}
.btn{background:rgba(245,166,35,.12);border:1px solid rgba(245,166,35,.35);color:var(--gold2);padding:9px 12px;border-radius:12px;font-weight:900;cursor:pointer;font-size:12px;}
.view-tabs{display:flex;gap:8px;flex-wrap:wrap;padding: 0 14px 14px;}
.view-tab{padding:8px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.03);color:var(--muted);font-size:12px;cursor:pointer;user-select:none;}
.view-tab.active{background:rgba(52,211,153,.10);border-color: rgba(52,211,153,.30);color:#c7fbe4;}
.tablewrap{padding:10px 12px 16px;}
.table{width:100%;border-collapse:separate;border-spacing:0;overflow:hidden;border-radius:16px;border:1px solid rgba(255,255,255,.06);}
.table thead th{
  position:sticky;top:0;z-index:5;background:rgba(8,14,22,.92);backdrop-filter: blur(10px);
  color:var(--muted);font-size:12px;text-align:left;padding:12px 10px;border-bottom:1px solid rgba(255,255,255,.06);
  cursor:pointer;white-space:nowrap;
}
.table thead th .arrow{opacity:.65;font-size:11px;margin-left:6px}
.table tbody td{padding:12px 10px;border-bottom:1px solid rgba(255,255,255,.06);vertical-align:top;}
.table tbody tr:hover td{background:rgba(255,255,255,.03);}
.ticker{font-weight:900;letter-spacing:.02em;}
.company{color:var(--muted);font-size:12px;margin-top:3px;max-width: 360px;}
.tags{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
.tag{display:inline-flex;align-items:center;gap:6px;padding:6px 9px;border-radius:999px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.03);color:var(--muted);font-size:12px;}
.tag.good{border-color: rgba(52,211,153,.35);background:rgba(52,211,153,.10);color:#baf7df;}
.tag.bad{border-color: rgba(251,113,133,.35);background:rgba(251,113,133,.10);color:#ffd0d8;}
.kpi{font-family:"JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;color:#d8e6f5;font-weight:800;font-size:12px;}
.scorepill{
  font-family:"JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
  font-weight:900;padding:6px 10px;border-radius:999px;display:inline-flex;align-items:center;gap:8px;
  border:1px solid rgba(255,255,255,.08);background:rgba(0,0,0,.16);
}
.scorepill .bar{width:60px;height:8px;border-radius:999px;background:rgba(255,255,255,.08);overflow:hidden;}
.scorepill .bar span{display:block;height:100%;width:50%;background: linear-gradient(90deg, rgba(57,195,255,.85), rgba(245,166,35,.9));}
.loading{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px;padding:60px 18px;text-align:center;}
.spinner{width:48px;height:48px;border-radius:50%;border:4px solid rgba(255,255,255,.10);border-top-color: var(--gold);animation: spin 1s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}
.error{display:none;padding:18px;margin-top:14px;border-radius:16px;border:1px solid rgba(251,113,133,.35);background:rgba(251,113,133,.08);color:#ffd0d8;}
.footer{margin-top:14px;color:var(--muted2);font-size:12px;display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;}
.small{font-family:"JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;}
/* Tooltip */
.tooltip{
  position:fixed; z-index:9999; pointer-events:none;
  background: rgba(10,16,26,.95); border:1px solid rgba(255,255,255,.10);
  padding:10px 12px; border-radius:12px; color:#eaf2fb; max-width: 320px;
  box-shadow: 0 20px 60px rgba(0,0,0,.45);
  display:none;
}
.tooltip .title{font-weight:900;margin-bottom:6px}
.tooltip .txt{color:#cbd5e1;font-size:12px;line-height:1.35}
.details-row td{padding:0;border-bottom:1px solid rgba(255,255,255,.06);}
.details{padding:14px 12px;background:rgba(0,0,0,.18);border-top:1px solid rgba(255,255,255,.06);display:grid;grid-template-columns: 1.1fr .9fr;gap:12px;}
.details .box{border:1px solid rgba(255,255,255,.08);border-radius:14px;background:rgba(255,255,255,.03);padding:12px;}
.details h3{margin:0 0 10px 0;font-size:13px;color:var(--muted);letter-spacing:.02em;}
.details ul{margin:0;padding-left:18px}
.details li{margin:6px 0;color:#d7e3f2;font-size:12px}
@media (max-width:1080px){.stats{grid-template-columns:repeat(2,1fr)} .details{grid-template-columns:1fr}}
@media (max-width:560px){.stats{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <div class="brand">
      <h1><span style="color:var(--gold)">S&P 500</span> Mozes Ranker</h1>
      <div class="sub">
        <span class="badge"><span class="dot"></span> v5.3 â€¢ 9-Pillar + Breakout Scanner</span>
        <span class="badge" id="lastUpdated"><span class="live-dot"></span><span id="genTxt">â€”</span></span>
      </div>
    </div>
    <div class="header-right">
      <div class="lang-toggle" dir="ltr">
        <button id="btnEn" class="active" onclick="setLang('en')">EN</button>
        <button id="btnHe" onclick="setLang('he')">×¢×‘×¨×™×ª</button>
      </div>
    </div>
  </div>

  <div id="loading" class="card loading">
    <div class="spinner"></div>
    <div style="font-weight:900;letter-spacing:-.01em;" id="loadingTitle">LOADING MARKET DATA...</div>
    <div class="small muted" id="loadingSub">Fetching sp500_data.json</div>
  </div>

  <div id="error-msg" class="error card"></div>

  <div id="statsBar" class="card stats" style="display:none">
    <div class="stat">
      <div class="label" id="statLabelRanked">Stocks Ranked</div>
      <div class="value" id="statCount">â€”</div>
      <div class="hint" id="statCountHint">stocks</div>
    </div>
    <div class="stat">
      <div class="label" id="statLabelAvg">Avg Composite</div>
      <div class="value" id="statAvg">â€”</div>
      <div class="hint small">0â€“100</div>
    </div>
    <div class="stat">
      <div class="label" id="statLabelTopSector">Top Sector</div>
      <div class="value" id="statTopSector">â€”</div>
      <div class="hint small" id="statTopSectorHint">by composite</div>
    </div>
    <div class="stat">
      <div class="label" id="statLabelSS8">SmartScore â‰¥ 8</div>
      <div class="value" id="statSS8">â€”</div>
      <div class="hint small" id="statSS8Hint">TipRanks coverage</div>
    </div>
  </div>

  <div id="controls" class="card controls" style="display:none">
    <div class="search">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" style="opacity:.7"><path d="M21 21l-4.3-4.3m1.8-5.2a7 7 0 11-14 0 7 7 0 0114 0z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
      <input id="q" placeholder="Search ticker or companyâ€¦" oninput="applyFilters()"/>
    </div>
    <div class="pills">
      <div class="pill" id="pSS8" onclick="togglePill('ss8')"><span class="mini"></span><span id="pSS8Label">SmartScore â‰¥ 8</span></div>
      <div class="pill" id="pBreakout" onclick="togglePill('breakout')"><span class="mini"></span><span id="pBreakoutLabel">Breakout only</span></div>
      <div class="pill" id="pTR" onclick="togglePill('tr')"><span class="mini"></span><span id="pTRLabel">TR Coverage</span></div>
      <button class="btn" onclick="resetAll()" id="btnReset">âœ• Reset</button>
    </div>
  </div>

  <div id="viewTabs" class="view-tabs" style="display:none">
    <div class="view-tab active" data-view="score" onclick="setView('score')" id="vtScore">ğŸ“Š Score</div>
    <div class="view-tab" data-view="valuation" onclick="setView('valuation')" id="vtVal">ğŸ’° Valuation</div>
    <div class="view-tab" data-view="profitability" onclick="setView('profitability')" id="vtProf">ğŸ’¹ Profitability</div>
    <div class="view-tab" data-view="growth" onclick="setView('growth')" id="vtGrowth">ğŸš€ Growth</div>
    <div class="view-tab" data-view="cashflow" onclick="setView('cashflow')" id="vtCF">ğŸ’µ Cash Flow</div>
    <div class="view-tab" data-view="health" onclick="setView('health')" id="vtHealth">ğŸ¦ Balance Sheet</div>
    <div class="view-tab" data-view="momentum" onclick="setView('momentum')" id="vtMom">âš¡ Momentum</div>
    <div class="view-tab" data-view="analyst" onclick="setView('analyst')" id="vtAnalyst">ğŸ”­ Analyst</div>
    <div class="view-tab" data-view="tipranks" onclick="setView('tipranks')" id="vtTR">ğŸ¯ TipRanks</div>
    <div class="view-tab" data-view="breakout" onclick="setView('breakout')" id="vtBreakout">âš¡ Breakout</div>
  </div>

  <div class="card tablewrap" style="margin-top:12px">
    <table class="table" id="tbl">
      <thead><tr id="thead"></tr></thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <div class="footer">
    <div class="muted" id="footerLeft">Data sources: yfinance + TipRanks (via pipeline)</div>
    <div class="muted small" id="footerRight">Click a row to expand details â€¢ Sort by clicking headers</div>
  </div>
</div>

<div class="tooltip" id="tooltip">
  <div class="title" id="ttTitle"></div>
  <div class="txt" id="ttText"></div>
</div>

<script>
const I18N = {
  en: {
    ranked:"Stocks Ranked", avg:"Avg Composite", topsec:"Top Sector", ss8:"SmartScore â‰¥ 8", tr:"TR Coverage", breakout:"Breakout only",
    stocks:"stocks", searchph:"Search ticker or companyâ€¦", reset:"âœ• Reset", byComp:"by composite",
    loadingTitle:"LOADING MARKET DATA...", loadingSub:"Fetching sp500_data.json",
    footerLeft:"Data sources: yfinance + TipRanks (via pipeline)",
    footerRight:"Click a row to expand details â€¢ Sort by clicking headers",
    tabs:{score:"ğŸ“Š Score", valuation:"ğŸ’° Valuation", profitability:"ğŸ’¹ Profitability", growth:"ğŸš€ Growth", cashflow:"ğŸ’µ Cash Flow",
          health:"ğŸ¦ Balance Sheet", momentum:"âš¡ Momentum", analyst:"ğŸ”­ Analyst", tipranks:"ğŸ¯ TipRanks", breakout:"âš¡ Breakout"},
    cols:{rank:"#", ticker:"Ticker", company:"Company", sector:"Sector", industry:"Industry",
      composite:"Composite", valuation:"Valuation", p_valuation:"Valuation Pillar", p_profitability:"Profitability Pillar", p_growth:"Growth Pillar",
      p_eq:"Earnings Quality Pillar", p_fcf:"FCF Pillar", p_health:"Health Pillar", p_momentum:"Momentum Pillar", p_analyst:"Analyst Pillar",
      tr_smartscore:"SmartScore", tr_consensus:"Consensus", pe:"P/E", fwd_pe:"Fwd P/E", peg:"PEG", ps:"P/S", pb:"P/B", ev_ebitda:"EV/EBITDA",
      roe:"ROE", roa:"ROA", roic:"ROIC", net_margin:"Net Margin", gross_margin:"Gross Margin", op_margin:"Op Margin",
      rev_growth:"Revenue Growth", eps_growth:"EPS Growth", fcf_yield:"FCF Yield", fcf_margin:"FCF Margin", fcf_to_ni:"FCF/NI",
      current_ratio:"Current Ratio", debt_equity:"Debt/Equity", altman_z:"Altman Z", piotroski_f:"Piotroski F",
      perf_12m:"12M %", perf_6m:"6M %", perf_3m:"3M %", perf_1m:"1M %", momentum:"Momentum", beta:"Beta", vs_sector:"Vs Sector",
      pt_upside:"PT Upside", analysts:"Analysts", analyst_mean:"Analyst Mean",
      tr_pt_upside:"TR Upside", tr_news_bull:"News", tr_blogger_bull:"Blogger", tr_insider:"Insider", tr_hedge:"Hedge",
      coverage:"Coverage", breakout_score:"Breakout Score", breakout_rank:"BO Rank", breakout_phase:"Phase", breakout_rr:"R/R",
      breakout_rs:"RS", breakout_entry:"Entry", breakout_stop:"Stop", vcp_quality:"VCP Quality", breakout_reasons:"Reasons"
    }
  },
  he: {
    ranked:"×× ×™×•×ª ××“×•×¨×’×•×ª", avg:"×¦×™×•×Ÿ ×××•×¦×¢", topsec:"×¡×§×˜×•×¨ ××•×‘×™×œ", ss8:"×¦×™×•×Ÿ ×—×›× â‰¥ 8", tr:"×›×™×¡×•×™ TipRanks", breakout:"×× ×™×•×ª ×¤×•×¨×¦×•×ª ×‘×œ×‘×“",
    stocks:"×× ×™×•×ª", searchph:"×—×¤×© ×˜×™×§×¨ ××• ×—×‘×¨×”â€¦", reset:"âœ• ××™×¤×•×¡", byComp:"×œ×¤×™ ×§×•××¤×•×–×™×˜",
    loadingTitle:"×˜×•×¢×Ÿ × ×ª×•× ×™ ×©×•×§...", loadingSub:"×˜×•×¢×Ÿ sp500_data.json",
    footerLeft:"××§×•×¨×•×ª × ×ª×•× ×™×: yfinance + TipRanks (×“×¨×š ×”×¤×™×™×¤×œ×™×™×Ÿ)",
    footerRight:"×œ×—×¥ ×¢×œ ×©×•×¨×” ×›×“×™ ×œ×”×¨×—×™×‘ â€¢ ××™×™×Ÿ ×‘×œ×—×™×¦×” ×¢×œ ×›×•×ª×¨×•×ª",
    tabs:{score:"ğŸ“Š ×¦×™×•×Ÿ", valuation:"ğŸ’° ×©×•×•×™", profitability:"ğŸ’¹ ×¨×•×•×—×™×•×ª", growth:"ğŸš€ ×¦××™×—×”", cashflow:"ğŸ’µ ×ª×–×¨×™×",
          health:"ğŸ¦ ×××–×Ÿ", momentum:"âš¡ ××•×× ×˜×•×", analyst:"ğŸ”­ ×× ×œ×™×¡×˜×™×", tipranks:"ğŸ¯ TipRanks", breakout:"âš¡ ×¤×¨×™×¦×”"},
    cols:{rank:"#", ticker:"×˜×™×§×¨", company:"×—×‘×¨×”", sector:"×¡×§×˜×•×¨", industry:"×ª×¢×©×™×™×”",
      composite:"×§×•××¤×•×–×™×˜", valuation:"×©×•×•×™", p_valuation:"×¢××•×“ ×©×•×•×™", p_profitability:"×¢××•×“ ×¨×•×•×—×™×•×ª", p_growth:"×¢××•×“ ×¦××™×—×”",
      p_eq:"××™×›×•×ª ×¨×•×•×—×™×", p_fcf:"×¢××•×“ FCF", p_health:"×¢××•×“ ×‘×¨×™××•×ª", p_momentum:"×¢××•×“ ××•×× ×˜×•×", p_analyst:"×¢××•×“ ×× ×œ×™×¡×˜×™×",
      tr_smartscore:"×¦×™×•×Ÿ ×—×›×", tr_consensus:"×§×•× ×¦× ×–×•×¡", pe:"××›×¤×™×œ ×¨×•×•×—", fwd_pe:"××›×¤×™×œ ×¢×ª×™×“×™", peg:"PEG", ps:"P/S", pb:"P/B", ev_ebitda:"EV/EBITDA",
      roe:"ROE", roa:"ROA", roic:"ROIC", net_margin:"××¨×•×•×— × ×˜×•", gross_margin:"××¨×•×•×— ×’×•×œ××™", op_margin:"××¨×•×•×— ×ª×¤×¢×•×œ×™",
      rev_growth:"×¦××™×—×ª ×”×›× ×¡×•×ª", eps_growth:"×¦××™×—×ª EPS", fcf_yield:"×ª×©×•××ª FCF", fcf_margin:"××¨×•×•×— FCF", fcf_to_ni:"FCF/NI",
      current_ratio:"×™×—×¡ ×©×•×˜×£", debt_equity:"×—×•×‘/×”×•×Ÿ", altman_z:"××œ×˜××Ÿ Z", piotroski_f:"×¤×™×•×˜×¨×•×¡×§×™ F",
      perf_12m:"12×— %", perf_6m:"6×— %", perf_3m:"3×— %", perf_1m:"1×— %", momentum:"××•×× ×˜×•×", beta:"×‘×˜×", vs_sector:"××•×œ ×¡×§×˜×•×¨",
      pt_upside:"××¤×¡×™×™×“ ×™×¢×“", analysts:"×× ×œ×™×¡×˜×™×", analyst_mean:"×××•×¦×¢ ×× ×œ×™×¡×˜",
      tr_pt_upside:"××¤×¡×™×™×“ TR", tr_news_bull:"×—×“×©×•×ª", tr_blogger_bull:"×‘×œ×•×’×¨×™×", tr_insider:"×¤× ×™×", tr_hedge:"×’×™×“×•×¨",
      coverage:"×›×™×¡×•×™", breakout_score:"×¦×™×•×Ÿ ×¤×¨×™×¦×”", breakout_rank:"×“×™×¨×•×’ ×¤×¨×™×¦×”", breakout_phase:"×¤××–×”", breakout_rr:"×™×—×¡ ×¡×™×›×•×Ÿ/×¡×™×›×•×™",
      breakout_rs:"RS", breakout_entry:"×›× ×™×¡×”", breakout_stop:"×¡×˜×•×¤", vcp_quality:"××™×›×•×ª VCP", breakout_reasons:"×¡×™×‘×•×ª"
    }
  }
};

const TOOLTIP = {
  composite: { en:{t:"Composite", d:"Overall score (0â€“100) combining 9 pillars. Higher = stronger allâ€‘around."},
              he:{t:"×§×•××¤×•×–×™×˜", d:"×¦×™×•×Ÿ ×›×•×œ×œ (0â€“100) ×©××©×§×œ×œ 9 ×¤×™×œ×¨×™×. ×’×‘×•×” ×™×•×ª×¨ = ××™×›×•×ª ×›×•×œ×œ×ª ×˜×•×‘×” ×™×•×ª×¨."}},
  valuation: { en:{t:"Valuation", d:"How attractive the stock looks by valuation multiples (P/E, P/S, P/B, EV/EBITDA). Higher = cheaper vs peers."},
              he:{t:"×©×•×•×™", d:"××˜×¨×§×˜×™×‘×™×•×ª ×œ×¤×™ ××›×¤×™×œ×™× (P/E, P/S, P/B, EV/EBITDA). ×’×‘×•×” ×™×•×ª×¨ = ×–×•×œ ×™×•×ª×¨ ×™×—×¡×™×ª."}},
  pe:        { en:{t:"P/E", d:"Price to Earnings ratio. Lower can be cheaper, but depends on growth/quality."},
              he:{t:"P/E", d:"××›×¤×™×œ ×¨×•×•×—. × ××•×š ×¢×©×•×™ ×œ×”×¢×™×“ ×¢×œ ×©×•×•×™ × ××•×š ×™×•×ª×¨, ×ª×œ×•×™ ×‘×¦××™×—×”/××™×›×•×ª."}},
  tr_smartscore:{en:{t:"SmartScore (TipRanks)", d:"TipRanks SmartScore 1â€“10. Higher = stronger multiâ€‘signal rating."},
                he:{t:"×¦×™×•×Ÿ ×—×›× (TipRanks)", d:"×¦×™×•×Ÿ TipRanks 1â€“10. ×’×‘×•×” ×™×•×ª×¨ = ×“×™×¨×•×’ ×—×–×§ ×™×•×ª×¨."}},
  tr_consensus:{en:{t:"Consensus", d:"Analyst consensus rating from TipRanks (Buy/Hold/Sell style)."},
               he:{t:"×§×•× ×¦× ×–×•×¡", d:"×“×™×¨×•×’ ×§×•× ×¦× ×–×•×¡ ×× ×œ×™×¡×˜×™× ×â€‘TipRanks (×§× ×™×”/×”×—×–×§×”/××›×™×¨×”)."}},
  perf_12m:{en:{t:"12M %", d:"Total price performance over the last 12 months."},
           he:{t:"12 ×—×•×“×©×™× %", d:"×‘×™×¦×•×¢ ××—×™×¨ ××¦×˜×‘×¨ ×‘â€‘12 ×”×—×•×“×©×™× ×”××—×¨×•× ×™×."}},
  altman_z:{en:{t:"Altman Z", d:"Financial distress indicator. Higher typically means lower bankruptcy risk."},
           he:{t:"××œ×˜××Ÿ Z", d:"××“×“ ×¡×™×›×•×Ÿ ×¤×™× × ×¡×™. ×’×‘×•×” ×™×•×ª×¨ ×œ×¨×•×‘ = ×¡×™×›×•×Ÿ ×¤×©×™×˜×ª ×¨×’×œ × ××•×š ×™×•×ª×¨."}},
  debt_equity:{en:{t:"Debt/Equity", d:"Leverage ratio. Lower generally means less debt vs equity."},
              he:{t:"×—×•×‘/×”×•×Ÿ", d:"×™×—×¡ ××™× ×•×£. × ××•×š ×œ×¨×•×‘ = ×¤×—×•×ª ×—×•×‘ ×‘×™×—×¡ ×œ×”×•×Ÿ."}},
  current_ratio:{en:{t:"Current Ratio", d:"Liquidity measure (current assets / current liabilities). Higher = more shortâ€‘term cushion."},
                he:{t:"×™×—×¡ ×©×•×˜×£", d:"× ×–×™×œ×•×ª (× ×›×¡×™× ×©×•×˜×¤×™× / ×”×ª×—×™×™×‘×•×™×•×ª ×©×•×˜×¤×•×ª). ×’×‘×•×” ×™×•×ª×¨ = ×›×¨×™×ª ×˜×•×‘×” ×™×•×ª×¨."}},
  breakout_score:{en:{t:"Breakout Score", d:"Score from the breakout scanner pipeline. Only available for tickers flagged as BUY signals."},
                 he:{t:"×¦×™×•×Ÿ ×¤×¨×™×¦×”", d:"×¦×™×•×Ÿ ××× ×•×¢ ×”×¤×¨×™×¦×•×ª. ××•×¤×™×¢ ×¨×§ ×œ×× ×™×•×ª ×©×¡×•×× ×• ×›â€‘BUY ×‘×¡×•×¨×§."}},
  breakout_rr:{en:{t:"R/R", d:"Risk/Reward ratio from the breakout scanner. Higher = better potential reward vs risk."},
              he:{t:"×¡×™×›×•×Ÿ/×¡×™×›×•×™", d:"×™×—×¡ ×¡×™×›×•×Ÿ/×¡×™×›×•×™ ××”×¡×•×¨×§. ×’×‘×•×” ×™×•×ª×¨ = ×¤×•×˜× ×¦×™××œ ×ª×’××•×œ ×’×“×•×œ ×™×•×ª×¨."}},
  breakout_stop:{en:{t:"Stop", d:"Suggested stop loss from the breakout scanner (if provided)."},
                he:{t:"×¡×˜×•×¤", d:"×¡×˜×•×¤Ö¾×œ×•×¡ ××•×¦×¢ ××”×¡×•×¨×§ (×× ×§×™×™×)."}}
};

const VIEW_COLS = {
  score:        ["rank","ticker","sector","composite","valuation","tr_smartscore","tr_consensus","pe","perf_12m","breakout_score"],
  valuation:    ["rank","ticker","sector","valuation","pe","fwd_pe","peg","ps","pb","ev_ebitda","div_yield","market_cap"],
  profitability:["rank","ticker","sector","p_profitability","roe","roa","roic","net_margin","gross_margin","op_margin","fcf_margin"],
  growth:       ["rank","ticker","sector","p_growth","rev_growth","eps_growth","tr_asset_gr","perf_12m"],
  cashflow:     ["rank","ticker","sector","p_fcf","fcf_yield","fcf_margin","fcf_to_ni","avg_volume"],
  health:       ["rank","ticker","sector","p_health","current_ratio","debt_equity","altman_z","piotroski_f","payout_ratio"],
  momentum:     ["rank","ticker","sector","p_momentum","perf_12m","perf_6m","perf_3m","perf_1m","momentum","beta","vs_sector"],
  analyst:      ["rank","ticker","sector","p_analyst","analysts","analyst_mean","pt_upside","tr_pt_upside","tr_news_bull","tr_blogger_bull"],
  tipranks:     ["rank","ticker","sector","tr_smartscore","tr_consensus","tr_pt_upside","tr_news_bull","tr_blogger_bull","tr_insider","tr_hedge","coverage"],
  breakout:     ["rank","ticker","sector","breakout_score","breakout_rank","breakout_phase","breakout_rr","breakout_rs","breakout_entry","breakout_stop","vcp_quality"]
};

let lang="en";
let allData=[];
let filtered=[];
let sortKey="composite";
let sortDir="desc";
let pills={ss8:false, breakout:false, tr:false};
let view="score";
let openTicker=null;

function t(k){ return (I18N[lang] && I18N[lang][k]) || I18N.en[k] || k; }
function ttab(k){ return (I18N[lang].tabs && I18N[lang].tabs[k]) || I18N.en.tabs[k] || k; }
function tcol(k){ return (I18N[lang].cols && I18N[lang].cols[k]) || I18N.en.cols[k] || k; }

function setLang(l){
  lang=l;
  document.getElementById("btnEn").classList.toggle("active", l==="en");
  document.getElementById("btnHe").classList.toggle("active", l==="he");
  document.documentElement.lang = l==="he" ? "he" : "en";
  document.body.dir = l==="he" ? "rtl" : "ltr";
  applyI18n();
  render();
}

function applyI18n(){
  document.getElementById("statLabelRanked").textContent=t("ranked");
  document.getElementById("statLabelAvg").textContent=t("avg");
  document.getElementById("statLabelTopSector").textContent=t("topsec");
  document.getElementById("statLabelSS8").textContent=t("ss8");
  document.getElementById("statCountHint").textContent=t("stocks");
  document.getElementById("statTopSectorHint").textContent=t("byComp");
  document.getElementById("statSS8Hint").textContent=t("tr");
  document.getElementById("q").placeholder=t("searchph");
  document.getElementById("btnReset").textContent=t("reset");
  document.getElementById("pSS8Label").textContent=t("ss8");
  document.getElementById("pBreakoutLabel").textContent=t("breakout");
  document.getElementById("pTRLabel").textContent=t("tr");
  document.getElementById("vtScore").textContent=ttab("score");
  document.getElementById("vtVal").textContent=ttab("valuation");
  document.getElementById("vtProf").textContent=ttab("profitability");
  document.getElementById("vtGrowth").textContent=ttab("growth");
  document.getElementById("vtCF").textContent=ttab("cashflow");
  document.getElementById("vtHealth").textContent=ttab("health");
  document.getElementById("vtMom").textContent=ttab("momentum");
  document.getElementById("vtAnalyst").textContent=ttab("analyst");
  document.getElementById("vtTR").textContent=ttab("tipranks");
  document.getElementById("vtBreakout").textContent=ttab("breakout");
  document.getElementById("loadingTitle").textContent=t("loadingTitle");
  document.getElementById("loadingSub").textContent=t("loadingSub");
  document.getElementById("footerLeft").textContent=t("footerLeft");
  document.getElementById("footerRight").textContent=t("footerRight");
}

function setView(v){
  view=v;
  document.querySelectorAll(".view-tab").forEach(el=>el.classList.toggle("active", el.dataset.view===v));
  if(v==="valuation"){ sortKey="valuation"; sortDir="desc"; }
  else if(v==="profitability"){ sortKey="p_profitability"; sortDir="desc"; }
  else if(v==="growth"){ sortKey="p_growth"; sortDir="desc"; }
  else if(v==="cashflow"){ sortKey="p_fcf"; sortDir="desc"; }
  else if(v==="health"){ sortKey="p_health"; sortDir="desc"; }
  else if(v==="momentum"){ sortKey="p_momentum"; sortDir="desc"; }
  else if(v==="analyst"){ sortKey="p_analyst"; sortDir="desc"; }
  else if(v==="tipranks"){ sortKey="tr_smartscore"; sortDir="desc"; }
  else if(v==="breakout"){ sortKey="breakout_score"; sortDir="desc"; }
  else{ sortKey="composite"; sortDir="desc"; }
  openTicker=null;
  render();
}

function togglePill(k){
  pills[k]=!pills[k];
  const id = k==="ss8" ? "pSS8" : k==="breakout" ? "pBreakout" : "pTR";
  document.getElementById(id).classList.toggle("active", pills[k]);
  applyFilters();
}

function resetAll(){
  pills={ss8:false, breakout:false, tr:false};
  document.getElementById("pSS8").classList.remove("active");
  document.getElementById("pBreakout").classList.remove("active");
  document.getElementById("pTR").classList.remove("active");
  document.getElementById("q").value="";
  openTicker=null;
  applyFilters();
}

function num(v){
  const n = typeof v==="string" ? Number(v) : v;
  return (n===null || n===undefined || Number.isNaN(n)) ? null : n;
}

function fmt(v, key){
  if(v===null || v===undefined) return "â€”";
  if(typeof v==="string"){
    if(v.trim()==="") return "â€”";
    return v;
  }
  if(Number.isNaN(v)) return "â€”";
  // percent-like keys
  if(key && (key.includes("perf_") || key.endsWith("_growth") || key.endsWith("_margin") || key.endsWith("_yield") || key==="pt_upside" || key==="tr_pt_upside" || key==="vs_sector")){
    return (v>=0?"+":"") + (v*1).toFixed(1) + "%";
  }
  if(key==="market_cap"){
    if(v>=1e12) return (v/1e12).toFixed(2)+"T";
    if(v>=1e9) return (v/1e9).toFixed(2)+"B";
    if(v>=1e6) return (v/1e6).toFixed(1)+"M";
    return String(v);
  }
  if(key==="avg_volume"){
    if(v>=1e6) return (v/1e6).toFixed(2)+"M";
    if(v>=1e3) return (v/1e3).toFixed(0)+"K";
    return String(Math.round(v));
  }
  if(typeof v==="number"){
    // integers
    if(Math.abs(v) >= 1000 && Number.isInteger(v)) return v.toLocaleString();
    // common decimals
    return (Math.round(v*100)/100).toString();
  }
  return String(v);
}

function applyFilters(){
  const q = (document.getElementById("q").value||"").trim().toLowerCase();
  filtered = allData.filter(r=>{
    if(q){
      const hay = ((r.ticker||"") + " " + (r.company||"") + " " + (r.sector||"") + " " + (r.industry||"")).toLowerCase();
      if(!hay.includes(q)) return false;
    }
    if(pills.ss8){
      const ss = num(r.tr_smartscore);
      if(ss===null || ss<8) return false;
    }
    if(pills.tr){
      const cov = num(r.coverage);
      if(cov===null || cov<=0) return false;
    }
    // user filter
    if(pills.breakout){
      const bo = num(r.breakout_score);
      if(bo===null || bo<=0) return false;
    }
    // view implicit filter: breakout tab only shows breakouts
    if(view==="breakout"){
      const bo = num(r.breakout_score);
      if(bo===null || bo<=0) return false;
    }
    return true;
  });

  render();
}

function cmp(a,b){
  if(a===null && b===null) return 0;
  if(a===null) return 1;
  if(b===null) return -1;
  if(typeof a==="string" && typeof b==="string") return a.localeCompare(b);
  return a-b;
}

function sortRows(rows){
  const k=sortKey;
  rows.sort((r1,r2)=>{
    const a = num(r1[k]); const b = num(r2[k]);
    let c = 0;
    if(a===null && b===null){
      // fallback string compare
      c = String(r1[k]??"").localeCompare(String(r2[k]??""));
    }else if(typeof a==="number" && typeof b==="number"){
      c = a-b;
    }else{
      c = cmp(a,b);
    }
    return sortDir==="asc" ? c : -c;
  });
  return rows;
}

function headerClick(k){
  if(sortKey===k){
    sortDir = (sortDir==="asc") ? "desc" : "asc";
  }else{
    sortKey = k;
    sortDir = "desc";
  }
  render();
}

function renderHeaders(){
  const cols = VIEW_COLS[view] || VIEW_COLS.score;
  const thead = document.getElementById("thead");
  thead.innerHTML = "";
  cols.forEach(k=>{
    const th=document.createElement("th");
    const arrow = (sortKey===k) ? (sortDir==="asc" ? "â–²" : "â–¼") : "";
    th.innerHTML = `<span data-k="${k}">${tcol(k)}<span class="arrow">${arrow}</span></span>`;
    th.onclick = ()=>headerClick(k);
    // Tooltip mapping: if specific tooltip exists; otherwise fallback to column label
    th.onmousemove = (e)=>showTip(e, k);
    th.onmouseleave = hideTip;
    thead.appendChild(th);
  });
}

function showTip(e, key){
  const tmap = TOOLTIP[key];
  const title = tmap ? tmap[lang].t : tcol(key);
  const txt = tmap ? tmap[lang].d : (lang==="he" ? "×œ×—×¥ ×›×“×™ ×œ××™×™×Ÿ ×œ×¤×™ ×¢××•×“×” ×–×•." : "Click to sort by this column.");
  const tt=document.getElementById("tooltip");
  document.getElementById("ttTitle").textContent = title;
  document.getElementById("ttText").textContent = txt;
  tt.style.display="block";
  const pad=14;
  let x = e.clientX + pad;
  let y = e.clientY + pad;
  const rect = tt.getBoundingClientRect();
  if(x + rect.width > window.innerWidth-8) x = window.innerWidth - rect.width - 8;
  if(y + rect.height > window.innerHeight-8) y = window.innerHeight - rect.height - 8;
  tt.style.left = x + "px";
  tt.style.top = y + "px";
}
function hideTip(){ document.getElementById("tooltip").style.display="none"; }

function renderRows(){
  const cols = VIEW_COLS[view] || VIEW_COLS.score;
  const tbody = document.getElementById("tbody");
  tbody.innerHTML="";
  const rows = sortRows([...filtered]);
  const showN = Math.min(rows.length, 500); // safety
  for(let i=0;i<showN;i++){
    const r=rows[i];
    const tr=document.createElement("tr");
    tr.style.cursor="pointer";
    tr.onclick=()=>toggleDetails(r.ticker);
    cols.forEach(k=>{
      const td=document.createElement("td");
      if(k==="ticker"){
        const ss = num(r.tr_smartscore);
        const cov = num(r.coverage);
        const ssTag = (ss!==null) ? `<span class="tag good" title="TipRanks SmartScore">SS ${ss}</span>` : ``;
        const trTag = (cov!==null && cov>0) ? `<span class="tag" title="TipRanks coverage">TR</span>` : ``;
        const bo = num(r.breakout_score);
        const boTag = (bo!==null && bo>0) ? `<span class="tag good" title="Breakout BUY signal">âš¡ BO</span>` : ``;
        td.innerHTML = `
          <div class="ticker">${r.ticker||"â€”"}</div>
          <div class="company">${r.company||""}</div>
          <div class="tags">${ssTag}${trTag}${boTag}</div>
        `;
      }else if(k==="composite"){
        const v=num(r.composite);
        const w = v===null ? 0 : Math.max(0, Math.min(100, v));
        td.innerHTML = `<span class="scorepill"><span class="kpi">${fmt(v,k)}</span><span class="bar"><span style="width:${w}%"></span></span></span>`;
      }else{
        td.innerHTML = `<span class="kpi">${fmt(r[k], k)}</span>`;
      }
      tr.appendChild(td);
    });
    tbody.appendChild(tr);

    if(openTicker && String(openTicker).toUpperCase()===String(r.ticker).toUpperCase()){
      const detTr=document.createElement("tr");
      detTr.className="details-row";
      const td=document.createElement("td");
      td.colSpan = cols.length;
      const reasons = (r.breakout_reasons||"").split("|").map(s=>s.trim()).filter(Boolean);
      const reasonLis = reasons.length ? reasons.map(x=>`<li>${x}</li>`).join("") : `<li class="muted">${lang==="he"?"××™×Ÿ ×¡×™×‘×•×ª/×¡×™×’× ×œ ×¤×¨×™×¦×” ×¢×‘×•×¨ ×× ×™×” ×–×•.":"No breakout reasons for this ticker."}</li>`;
      td.innerHTML = `
        <div class="details">
          <div class="box">
            <h3>${lang==="he"?"×¡×™×›×•×":"Summary"}</h3>
            <ul>
              <li><b>${lang==="he"?"×¡×§×˜×•×¨":"Sector"}:</b> ${(r.sector||"â€”")}</li>
              <li><b>${lang==="he"?"×§×•××¤×•×–×™×˜":"Composite"}:</b> ${fmt(r.composite,"composite")}</li>
              <li><b>${lang==="he"?"×©×•×•×™":"Valuation"}:</b> ${fmt(r.valuation,"valuation")}</li>
              <li><b>${lang==="he"?"××œ×˜××Ÿ Z":"Altman Z"}:</b> ${fmt(r.altman_z,"altman_z")}</li>
            </ul>
          </div>
          <div class="box">
            <h3>${lang==="he"?"×¡×™×’× ×œ ×¤×¨×™×¦×”":"Breakout Signal"}</h3>
            <ul>
              <li><b>${lang==="he"?"×¦×™×•×Ÿ ×¤×¨×™×¦×”":"Breakout Score"}:</b> ${fmt(r.breakout_score,"breakout_score")}</li>
              <li><b>${lang==="he"?"×“×™×¨×•×’":"Rank"}:</b> ${fmt(r.breakout_rank,"breakout_rank")}</li>
              <li><b>${lang==="he"?"×¤××–×”":"Phase"}:</b> ${fmt(r.breakout_phase,"breakout_phase")}</li>
              <li><b>${lang==="he"?"R/R":"R/R"}:</b> ${fmt(r.breakout_rr,"breakout_rr")}</li>
              <li><b>${lang==="he"?"×¡×˜×•×¤":"Stop"}:</b> ${fmt(r.breakout_stop,"breakout_stop")}</li>
              <li><b>${lang==="he"?"××™×›×•×ª VCP":"VCP Quality"}:</b> ${fmt(r.vcp_quality,"vcp_quality")}</li>
              ${reasonLis}
            </ul>
          </div>
        </div>
      `;
      detTr.appendChild(td);
      tbody.appendChild(detTr);
    }
  }
}

function toggleDetails(ticker){
  const t = String(ticker||"");
  if(openTicker && String(openTicker).toUpperCase()===t.toUpperCase()){
    openTicker=null;
  }else{
    openTicker=t;
  }
  render();
}

function render(){
  renderHeaders();
  renderRows();
}

function computeStats(data){
  document.getElementById("statCount").textContent = String(data.length);
  const avg = data.reduce((s,r)=>s + (num(r.composite)||0), 0) / Math.max(1,data.length);
  document.getElementById("statAvg").textContent = (Math.round(avg*10)/10).toFixed(1);

  // top sector by average composite
  const bySector = {};
  data.forEach(r=>{
    const s = r.sector || "â€”";
    bySector[s] = bySector[s] || {sum:0, n:0};
    bySector[s].sum += (num(r.composite)||0);
    bySector[s].n += 1;
  });
  let best="â€”", bestV=-1;
  Object.entries(bySector).forEach(([k,v])=>{
    const m = v.sum/Math.max(1,v.n);
    if(m>bestV){bestV=m; best=k;}
  });
  document.getElementById("statTopSector").textContent = best;

  const ss8 = data.filter(r=>{ const ss=num(r.tr_smartscore); return ss!==null && ss>=8; }).length;
  document.getElementById("statSS8").textContent = String(ss8);
}

async function loadData(){
  try{
    applyI18n();
    const res = await fetch("sp500_data.json?v="+Date.now(), {cache:"no-store"});
    if(!res.ok) throw new Error("HTTP "+res.status);
    const json = await res.json();
    const rows = Array.isArray(json) ? json : (json.data || []);
    if(!Array.isArray(rows)) throw new Error("JSON structure unexpected (expected array or {data:[]})");

    allData = rows;
    computeStats(allData);

    const g = (json.generated || json.converted_at || json.scan_date || "");
    document.getElementById("genTxt").textContent = g ? g : "â€”";

    document.getElementById("loading").style.display="none";
    document.getElementById("statsBar").style.display="grid";
    document.getElementById("controls").style.display="flex";
    document.getElementById("viewTabs").style.display="flex";

    // default: score view
    filtered = allData;
    render();
  }catch(e){
    console.error(e);
    document.getElementById("loading").style.display="none";
    const err=document.getElementById("error-msg");
    err.style.display="block";
    err.innerHTML = `<div style="font-weight:900;margin-bottom:6px;">ERROR</div><div class="small">${e.message}</div>`;
  }
}

loadData();
</script>
</body>
</html>
